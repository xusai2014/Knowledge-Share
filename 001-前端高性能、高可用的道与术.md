
## 前端高可用的道与术

- 监控预警体系
- 网络应用质量

### 一、监控预警体系

**核心指标稳定性、高可用**

>>> 移动端的不可用场景，闪退、白屏黑屏、打不开页面、功能无法正常使用，要做的事情是降低不可用场景，快速解决不可用问题。

APP技术很成熟，开发、测试、灰度验证流程，在一定程度上保证了APP可用性。问题在于千分之一的影响率随着用户量级增长，问题是会被放大，就是不可用风险。
动态化修复方案，频繁的动态变更增加了可用性风险。风险带来压力和挑战，如何解决这个问题？ **高可用监控技术体系**。

---

#### 高可用监控体系的发展历程

+ 1.0 时代
          
 ```
 闪退监控--->诊断上报-->监控闪退率-->分析解决-->发布新版 
 ```
---          
+ 2.0 时代
   - 稳定性监控体系，丰富监控问题点，提高了诊断能力和修复能力。
   - 监控日志全，特征、局部不可用问题无法准确通过监控平台描述出来，日志分析并不能马上定位所有问题， 问题发现后有可能等待发版，出现不可用场景
---
+ 3.0 时代   
   - 重新定义客户端高可用：通过专门设计结合整套技术体系，保持用户遇到不可用的总次数很低。
   - 高可用目标，可用率4个9。什么是可用率，是可用次数在使用次数的占比，99.99%高可用率。
        
   努力达到这个目标，如下措施：
   1. 可用性监控（**做好日志监控**）
      - 问题采集，如何采集到较全不可用问题？不可用问题分为，稳定性不可用（收集不到的不断收集类型补充进来）、业务不可用（业务不可用埋点）。
      - 统一管控，采集问题后，做出整体性、全面性可用率指标， 通过指标反应APP在使用人群中状况？对问题进行分类，建立特征，以此设计监控和报警。优化稳定性监控方案
      - 埋点上报，提高埋点准确性、实时率、到达率。 如何保证不可用情况下埋点实时上报，Android（独立进程上送）、IOS（ 延迟退出，先上送完日志，
            下一次打开补偿上送）
              
    2. 高灵敏报警平台 （**提早发现问题**）
       - 收集到问题后，做出报警，提早发现问题。
       - 分析与决策，当早期少量用户出现问题时，基于人群特征、问题特征 ，聚合采集到问题，设定规则判断是否不可用事件。分发问题到开发和测试人员， 
            
    3. 高可用容灾平台
       - 故障分类：非变更故障、变更故障
       - 变更故障，根据版本记录追踪问题，判断是否可以回滚，如不可回滚，启动紧急发布，如不可发布依 赖客户端修复
       - 非变更故障，收集系统灰度发布不兼容性问题、本地脏数据、安装问题、代码bug等，本地容灾、动态修复，为不同类型问题提供确定解决方案。
           
    4. 快速修复能力 （**建立问题严重性级别，设定修复时间**）
       - APP发布比较困难，使用动态修复，hot patch、数据化配置、重新部署模块，修复原则效率最高、风险最低。
       - 稳定下发通道，保证用户可以在极端情况下可以拉取修复方案。
       - 定点推送修复方案，只推送给需要使用的人。
           
    5. 故障演练
       - 可控成本进行先上故障发现快速解决，检验高可用。
       - 攻防演练方式，提高稳定性监控系统使用效率。
           
 留下小小的延申話題點？
  - 智能化（不可用问题的决策采用深度学习，去实现智能报警）
  - 自动化（容灾自动化）
  - 产品化（监控系统产品化）

---

### 二、网络应用质量

>>> 提高用户体验是在网络分发健康、程序代码时间复杂度合理基础之上。这两者必须结合在一起去讨论，脱离里哪一方都无法建立说的通的方案，这里涉及到一个平衡。

#### 前端性能分析

提高性能前，用户在哪里花费大量时间等待。围绕两张图：

图A
<img src='https://learning.oreilly.com/library/view/high-performance-web/9780596529307/httpatomoreillycomsourceoreillyimages49263.png'>
图B
<img src='https://learning.oreilly.com/library/view/high-performance-web/9780596529307/httpatomoreillycomsourceoreillyimages49265.png'>

图A是来自于IE加载yahoo的网络记录，每个进度条代表一个请求。第一个进度条是被标记为HTML，HTML文档的初始请求。浏览器解析HTML并开始下载页面其它模块。在这张图中，浏览器缓存是空的，所以
所有的模块都需要下载。HTML文档仅仅占用整个响应时长的5%，用户花费了95%时间去等待其它模块下载，当然还有一小部分时间消耗在了HTML、Scripts、Stylesheets的解析，这部分时间在图中描述就是下载请求间的空白间隙。

图B展示的是A中相同的地址第二次在IE中请求的情况，HTML模块仅占用响应总时长的12%，大多数模块因为浏览器已经缓存了无需下载。有五种模块在图B中产生了请求记录。

- One redirect（一个重定向请求）
该重定向是之前被下载但是浏览器会再次请求。HTTP响应状态码是302（Found or 'Moved temporarily'）,响应头中午缓存信息，所以浏览器不能缓存这个响应能容
- Three uncached images（三个无缓存的图片请求）
接下来的三个图片请求是在第一次图A中没有被下载过的，可能是新的照片或者频繁更换的广告内容。
- One cached image（一个缓存图片请求）
最后一个图片请求是一个有条件GET请求。图片已被缓存在浏览器中，但由于HTTP响应头，在展示给用户看到之前浏览器不得不去检查这个图片是最新的


时间消耗在哪里？
在上面这个过程我们观察HTTP流量，终端用户响应时间至少80%花费在这些页面模块上。如果深度挖掘这些图的细节，我们会发现浏览器和HTTP相互作用十分复杂。之前，我们提到HTTP状态码和响应头影响浏览器的缓存。此外，我们可以做如下的观察：
- 第二次图B缓存场景中没有那么多的下载活动。相反，你能看到一个白色空白长条在HTL文档请求后无下载活动。这些时间是浏览器解析HTML、Javascript和CSS以及从缓存中获取模块所占用的。


- [《高性能浏览网络》](http://shop.oreilly.com/product/0636920028048.do)
如何构建快速和高效的网络应用，从网络这个切入点，可以从影响性能的限制到如何构建强大浏览器的诸多创新层面去探讨（***HHTP2.0、WebRTC、XHR IMPROveMENTS、Websockets、Server-sent Events***）。

速度影响用户体验、留存、转化。解剖速度，需从网络传输的延迟、带宽两点来考量。
   - 延迟(从发送流量包到接收目标)

          
   - 带宽（逻辑或物理通信路径的最大吞吐量）


HTTP1与HTTP2
网络传输协议版本


              
